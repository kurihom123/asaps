{% extends 'pages/base.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">

  <!-- Display success/error messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">
      Reports & Announcements
      {% if role_name not in top_positions %}
        {% with unviewed_count=reports_info|length %}
        <span class="badge bg-danger ms-2">
          {{ reports_info|length }} Not Viewed
        </span>
        {% endwith %}
      {% endif %}
    </h4>

    {% if request.user.is_staff and request.user.user_profile.first.position.name|lower == 'treasurer' %}
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReportModal">
        Add Report
      </button>
    {% endif %}
  </div>

  <!-- Reports Table -->
  <div class="card shadow-sm rounded-4">
    <div class="card-body">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Report About</th>
            <th>Date Uploaded</th>
            <th>Uploaded By</th>
            {% if role_name not in top_positions %}
            <th>Viewed By</th>
            {% endif %}
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for info in reports_info %}
          <tr {% if not info.user_viewed and role_name not in ['president', 'general secretary', 'treasurer'] %} class="table-warning" {% endif %}>
            <td>{{ info.report.report_about }}</td>
            <td>{{ info.report.created_at|date:"M d, Y" }}</td>
            <td>{{ info.report.user.username }}</td>

            {% if role_name not in top_positions %}
            <td>
              {% if info.viewed_by_users %}
                <ul class="list-unstyled mb-0">
                  {% for rv in info.viewed_by_users %}
                    <li>
                      {{ rv.user.username }}{% if rv.user == request.user %} (You){% endif %} - {{ rv.viewed_at|date:"M d, Y H:i" }}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted">No views yet</span>
              {% endif %}
            </td>
            {% endif %}

            <td>
              <!-- View button -->
              <a href="?view_id={{ info.report.id }}" class="btn btn-outline-info btn-sm">View</a>
              <!-- Download button -->
              <a href="{% url 'download_report' info.report.id %}" class="btn btn-outline-success btn-sm">⬇️ Download</a>
              {% if role_name not in top_positions %}
              <!-- Views button for top users -->
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewsModal{{ info.report.id }}">
                Views
              </button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="{% if role_name in ['president', 'general secretary', 'treasurer'] %}5{% else %}4{% endif %}" class="text-center text-muted">
              No reports available yet.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal for Upload -->
<div class="modal fade" id="addReportModal" tabindex="-1" aria-labelledby="addReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addReportModalLabel">Upload New Report</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" enctype="multipart/form-data" action="{% url 'add_report' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="report_about" class="form-label">Report Title / About</label>
            <input type="text" name="report_about" class="form-control" placeholder="e.g. 2023-2025 Expenditures Report" required>
          </div>
          <div class="mb-3">
            <label for="report_file" class="form-label">Attach Report (PDF only)</label>
            <input type="file" name="report_file" accept="application/pdf" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Views Modals for top users -->
{% for info in reports_info %}
  {% if role_name not in top_positions %}
  <div class="modal fade" id="viewsModal{{ info.report.id }}" tabindex="-1" aria-labelledby="viewsModalLabel{{ info.report.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="viewsModalLabel{{ info.report.id }}">Users Who Viewed "{{ info.report.report_about }}"</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% if info.viewed_by_users %}
            <ul class="list-group">
              {% for rv in info.viewed_by_users %}
                <li class="list-group-item">
                  {{ rv.user.username }}{% if rv.user == request.user %} (You) {% endif %} - {{ rv.viewed_at|date:"M d, Y H:i" }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">No views yet.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

<script>
function markViewed(reportId) {
  fetch(`/reports/${reportId}/mark-viewed/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  }).then(() => {
    // Reload page to show "You viewed this document" message immediately
    location.reload();
  });
}
</script>

{% endblock %}
