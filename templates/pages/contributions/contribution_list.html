{% extends 'pages/base.html' %}
{% load widget_tweaks %}
{% load dict_extras %}

{% block content %}
<div class="container mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-secondary">
            <i class="fa fa-hand-holding-dollar"></i> Contribution Records
        </h3>
        {% if request.user.is_staff and request.user.user_profile.first.position.name|lower == 'treasurer' %}
        <div class="d-flex align-items-center gap-2">
            <!-- Excel Upload Form -->
            <form method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                {% csrf_token %}
                {{ upload_form.year|add_class:"form-select w-auto" }}
                {{ upload_form.excel_file|add_class:"form-control w-auto" }}
                <button type="submit" class="btn btn-success">
                    <i class="fa fa-upload"></i> Upload Excel
                </button>
            </form>

            <!-- Add Year Button -->
            <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#addYearModal">
                <i class="fa fa-plus"></i> Add Year
            </button>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="addYearModal" tabindex="-1" aria-labelledby="addYearModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="addYearModalLabel">
                <i class="fa fa-calendar-plus text-secondary"></i> Add New Contribution Year
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                <label class="form-label">Enter Year (e.g. 2025-2026)</label>
                <input type="text" name="new_year" class="form-control" placeholder="2025-2026" required>
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-dark">Save Year</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        {% endif %}

    </div>

    <!-- ALERT MESSAGES -->
    {% if messages %}
        <div id="alert-container">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm auto-dismiss" role="alert" data-dismiss-time="4000">
                    <i class="fa fa-info-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- YEARLY CONTRIBUTION TABLES (COLLAPSIBLE) -->
    <div class="accordion" id="yearAccordion">
        {% for year, contributions in grouped_contributions.items %}
        <div class="accordion-item mb-3 border-0 shadow-sm">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <button class="accordion-button collapsed fw-semibold text-dark"
                        style="background-color: rgba(245, 245, 245, 0.9); border-bottom: 1px solid #ddd;"
                        type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}"
                        aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                        <i class="fa fa-calendar me-2 text-secondary"></i> Bills for {{ year }}
                </button>
            </h2>

            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
                 aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#yearAccordion">
                <div class="accordion-body bg-light">

                    <div class="d-flex justify-content-end mb-2">
                        <a href="{% url 'contributions_pdf' year %}" target="_blank" class="btn btn-sm btn-outline-danger me-1">
                            <i class="fa fa-file-pdf"></i>
                        </a>
                        <a href="{% url 'contributions_excel' year %}" class="btn btn-sm btn-outline-success me-1">
                            <i class="fa fa-file-excel"></i>
                        </a>
                        <a href="{% url 'invoice_pdf' year %}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fa fa-file-invoice-dollar"></i>
                        </a>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped mb-0 align-middle text-center">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 15%"><i class="fa fa-university"></i> Association</th>
                                    <th style="width: 10%"><i class="fa fa-users"></i> Members</th>
                                    <th style="width: 15%"><i class="fa fa-money-bill"></i> Amount Paid</th>
                                    <th style="width: 15%"><i class="fa fa-calculator"></i> Allocation</th>
                                    <!-- <th style="width: 15%"><i class="fa fa-calendar-check"></i> Payment Date</th> -->
                                    <th style="width: 15%"><i class="fa fa-balance-scale"></i>Outstanding Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contribution in contributions %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td class="text-start">{{ contribution.association.abbr }}</td>
                                    <td>{{ contribution.association.member_number }}</td>
                                    <td>{{ contribution.amount_paid|floatformat:0 }}</td>
                                    <td>{{ contribution.allocation|floatformat:0 }}</td>
                                    <!-- <td>{{ contribution.payment_date }}</td> -->
                                    <td style="color: {% if contribution.balance > 0 %}red{% else %}green{% endif %};">
                                        {{ contribution.balance|floatformat:0 }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="fw-bold table-light">
                                <tr>
                                    <td></td>
                                    <td class="text-start">TOTAL</td>
                                    <td>{{ total_members_by_year|dict_get:year }}</td>
                                    <td>{{ total_requested_by_year|dict_get:year }}</td>
                                    <td>{{ total_allocation_by_year|dict_get:year }}</td>
                                    <td></td>
                                    <td style="color:red;">{{ total_balance_by_year|dict_get:year }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- UPLOAD HISTORY -->
                    <div class="mt-3">
                        <strong><i class="fa fa-history"></i> Upload History:</strong><br>
                        {% for upload in uploads %}
                            {% if upload.year == year %}
                                <small class="text-muted">
                                    {{ upload.uploaded_at|date:"M d, Y H:i" }} by {{ upload.uploaded_by.username }}
                                    <a href="{{ upload.excel_file.url }}" download class="text-primary ms-2">
                                        <i class="fa fa-download"></i> Download
                                    </a>
                                </small><br>
                            {% endif %}
                        {% endfor %}
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}



